apiVersion: v1
kind: Secret
metadata:
  name: ultrarag-mcp-basic-auth
  namespace: default
type: Opaque
stringData:
  users: |
    admin:$apr1$q/2.0/mcp$1

---
apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
  name: ultrarag-mcp-cors
  namespace: default
spec:
  headers:
    accessControlAllowMethods:
      - GET
      - POST
      - OPTIONS
    accessControlAllowHeaders:
      - Content-Type
      - Accept
      - Authorization
    accessControlAllowOriginList:
      - "*"
    accessControlMaxAge: 100
    addVaryHeader: true

---
apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
  name: ultrarag-mcp-rewrite-retriever
  namespace: default
spec:
  replacePathRegex:
    regex: "^/retriever/mcp(.*)"
    replacement: "/mcp$1"

---
apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
  name: ultrarag-mcp-auth
  namespace: default
spec:
  basicAuth:
    secret: ultrarag-mcp-basic-auth

---
apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
  name: ultrarag-mcp-retriever-chain
  namespace: default
spec:
  chain:
    middlewares:
      - name: ultrarag-mcp-rewrite-retriever
      - name: ultrarag-mcp-cors

---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: ultrarag-mcp-retriever-secure
  namespace: default
  annotations:
    traefik.ingress.kubernetes.io/router.entrypoints: websecure
    traefik.ingress.kubernetes.io/router.tls: "true"
    traefik.ingress.kubernetes.io/router.middlewares: default-ultrarag-mcp-retriever-chain@kubernetescrd,default-ultrarag-mcp-auth@kubernetescrd
    traefik.ingress.kubernetes.io/redirect-entry-point: https
    traefik.ingress.kubernetes.io/redirect-permanent: "true"
spec:
  ingressClassName: traefik
  rules:
    - host: retriever-mcp.metaglobe.finance
      http:
        paths:
          - path: /retriever/mcp
            pathType: Prefix
            backend:
              service:
                name: ultrarag-mcp-service
                port:
                  number: 8002

---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: ultrarag-mcp-retriever-dev
  namespace: default
  annotations:
    traefik.ingress.kubernetes.io/router.entrypoints: websecure
    traefik.ingress.kubernetes.io/router.tls: "true"
    traefik.ingress.kubernetes.io/router.middlewares: default-ultrarag-mcp-retriever-chain@kubernetescrd
    traefik.ingress.kubernetes.io/redirect-entry-point: https
    traefik.ingress.kubernetes.io/redirect-permanent: "true"
spec:
  ingressClassName: traefik
  rules:
    - host: retriever-mcp-dev.metaglobe.finance
      http:
        paths:
          - path: /retriever/mcp
            pathType: Prefix
            backend:
              service:
                name: ultrarag-mcp-service
                port:
                  number: 8002
